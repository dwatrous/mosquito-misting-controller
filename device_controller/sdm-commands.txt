# Create Debian host in GCE for the following steps
# sudo apt update
# sudo apt install -y git fdisk
# gcloud auth login
# gcloud source repos clone MosquitoMax
# cd MosquitoMax/device_controller

# curl -L https://raw.githubusercontent.com/gitbls/sdm/master/EZsdmInstaller V9.1.1 | bash

# sudo cp mmsetup /usr/local/sdm/local-plugins/
# sudo chmod +x /usr/local/sdm/local-plugins/mmsetup

# https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2023-10-10/
# e.g. curl -o 2023-10-10-raspios-bookworm-armhf-lite.img.xz https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2023-10-10/2023-10-10-raspios-bookworm-armhf-lite.img.xz
# e.g. curl -o 2023-05-03-raspios-bullseye-armhf-lite.img.xz https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2023-05-03/2023-05-03-raspios-bullseye-armhf-lite.img.xz
# unxz -k 2023-05-03-raspios-bullseye-armhf-lite.img.xz 
# OR Use 7zip to extract on Windows


# working hotspot
sudo sdm --customize --plugin disables:piwiz --plugin L10n:host --plugin user:"adduser=mm|password=secret" --plugin hotspot:"config=hotspot.cfg" --restart --host mmdwatrous 2023-05-03-raspios-bullseye-armhf-lite.img
sudo sdm --burnfile sdm.img --expand-root 2023-05-03-raspios-bullseye-armhf-lite.img

# captive portal
sudo sdm --customize --plugin raspiconfig:"i2c=1" --plugin copyfile:"filelist=/usr/local/bin/" --plugin disables:piwiz --plugin L10n:host --plugin user:"adduser=mm|password=secret" --plugin wificonfig:"country=us" --restart --host mmdwatrous 2023-05-03-raspios-bullseye-armhf-lite.img
sudo sdm --burnfile sdm.img --expand-root 2023-05-03-raspios-bullseye-armhf-lite.img

# normal wifi connected
sudo sdm --customize --plugin raspiconfig:"i2c=0" --plugin copyfile:"filelist=sdmfilelist" --plugin disables:piwiz --plugin L10n:host --plugin user:"adduser=mm|password=secret" --plugin user:"deluser=pi" --plugin network:"netman=nm|wifissid='Wishy Washy'|wifipassword='not to late to fate'|wificountry=US|noipv6" --plugin apps:"apps=python3-pip,python3-venv" --plugin mmsetup --extend --xmb 500 --restart --host mmdwatrous 2023-10-10-raspios-bookworm-armhf-lite.img
sudo sdm --burnfile mm.img --expand-root 2023-05-03-raspios-bullseye-armhf-lite.img
# on GCE
xz -k mm.img
gsutil cp mm.img.xz gs://sdm-builds
